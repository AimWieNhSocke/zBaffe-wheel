<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BAFFE WHEEL</title>

  <style>
    :root{
      --bgSolid: rgba(8, 6, 18, .92);
      --text: #ffffff;
      --btnGlow: rgba(0,195,255,.55);
      --btnBg1: #6a5cff;
      --btnBg2: #00c3ff;
      --inputBg: rgba(0,0,0,.30);
      --card: rgba(20, 10, 35, .92);
      --border: rgba(120,180,255,.35);
    }

    html, body { height: 100%; margin: 0; }
    body{
      display:grid;
      place-items:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      overflow-y:auto;
      overflow-x:hidden;
    }
    body.transparent{ background: transparent; }
    body.solid{ background: var(--bgSolid); }

    .wrap{
      width: min(720px, 94vw);
      display:grid;
      gap: 12px;
      justify-items:center;
      user-select:none;
      padding: 16px 0 22px 0;
    }

    .header{
      width:100%;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .title{
      font-weight: 1000;
      letter-spacing: .6px;
      font-size: 18px;
      padding: 8px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 0 18px rgba(106,92,255,.18);
      cursor: pointer;
    }

    .toggles{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    select, .miniBtn{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.28);
      color: #fff;
      outline: none;
      font-weight: 900;
      cursor: pointer;
    }

    .wheelBox{
      position: relative;
      width: 100%;
      aspect-ratio: 1/1;
      filter: drop-shadow(0 16px 40px rgba(0,0,0,.35));
    }

    canvas{ width:100%; height:100%; border-radius: 50%; }

    .pin{
      position:absolute;
      top:-6px; left:50%;
      transform:translateX(-50%);
      width:0; height:0;
      border-left: 18px solid transparent;
      border-right: 18px solid transparent;
      border-bottom: 34px solid rgba(255,255,255,.95);
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
      cursor: pointer;
    }

    .centerCap{
      position:absolute;
      inset: 50% auto auto 50%;
      transform: translate(-50%,-50%);
      width: 18%;
      aspect-ratio: 1/1;
      border-radius: 50%;
      background: rgba(255,255,255,.95);
      box-shadow: inset 0 0 0 10px rgba(0,0,0,.12), 0 0 26px rgba(0,195,255,.25);
      cursor: pointer;
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
    }

    button{
      appearance:none;
      border:0;
      padding: 12px 16px;
      border-radius: 14px;
      color: #ffffff;
      font-weight: 1000;
      cursor:pointer;
      transition: transform .06s ease, box-shadow .15s ease, opacity .15s ease;
      background: linear-gradient(135deg, var(--btnBg1), var(--btnBg2));
      box-shadow: 0 0 16px var(--btnGlow);
    }
    button:active{ transform: scale(.98); box-shadow: 0 0 10px rgba(0,195,255,.75); }
    button:disabled{ opacity:.55; cursor:not-allowed; box-shadow: none; }

    textarea{
      width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.22);
      background: var(--inputBg);
      color:#fff;
      outline:none;
      resize: vertical;
      font-weight: 800;
      line-height: 1.2;
    }

    .overlay{
      position: fixed;
      inset: 0;
      display: none;
      place-items: center;
      z-index: 10000;
      background: rgba(0,0,0,.55);
    }

    .box{
      width: min(560px, 92vw);
      padding: 18px 16px;
      border-radius: 18px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: 0 0 30px rgba(0,195,255,.22);
      text-align: center;
    }

    .box h2{
      margin: 0 0 10px 0;
      font-size: 20px;
      font-weight: 1100;
    }

    .box p{
      margin: 0 0 12px 0;
      opacity: .92;
      font-weight: 800;
    }

    .img{
      width: min(360px, 78vw);
      height: auto;
      display: block;
      margin: 0 auto;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.45));
    }

    .boxActions{
      display:grid;
      gap:10px;
      margin-top: 12px;
    }

    .btnSecondary{
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: none;
    }

    .winnerName{
      font-size: 28px;
      font-weight: 1200;
      letter-spacing: .2px;
      margin: 2px 0 10px 0;
      word-break: break-word;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
    }

    .field{
      width: min(420px, 92vw);
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.28);
      color:#fff;
      outline:none;
      font-weight: 900;
    }

    .smallNote{
      font-size: 12px;
      opacity: .85;
      margin-top: 8px;
      font-weight: 800;
    }

    .toast{
      position: fixed;
      right: 14px;
      bottom: 40px;
      z-index: 11000;
      opacity: 0;
      transform: translateY(6px);
      pointer-events: none;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(6px);
      font-size: 12px;
      font-weight: 1000;
      letter-spacing: .2px;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{ opacity: .94; transform: translateY(0); }

    .wm-btn{
      position: fixed;
      right: 14px;
      bottom: 12px;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      z-index: 10999;
      opacity: .08;
      cursor: pointer;
      background: rgba(255,255,255,.95);
      border: 1px solid rgba(255,255,255,.25);
    }
    .wm-btn:hover{ opacity: .22; }

    .ahaFlash{ animation: ahaFlash .35s ease 0s 1; }
    @keyframes ahaFlash{
      0%{ filter: none; }
      50%{ filter: saturate(1.8) contrast(1.2) brightness(1.2); }
      100%{ filter: none; }
    }
  </style>
</head>

<body class="solid">

  <!-- AHA Easter Egg -->
  <div class="overlay" id="ahaOverlay">
    <div class="box">
      <h2>Gl√ºckwunsch üéâ</h2>
      <p>du hast das gefunden</p>
      <img src="AHA.png" class="img" alt="AHA Meme">
      <div class="boxActions">
        <button id="ahaClose">OK</button>
      </div>
    </div>
  </div>

  <!-- Winner Popup -->
  <div class="overlay" id="winnerOverlay">
    <div class="box">
      <h2>Ausgew√§hlt</h2>
      <div class="winnerName" id="winnerName">---</div>
      <p id="winnerSubtitle">Was willst du machen?</p>
      <div class="boxActions">
        <button class="btnSecondary" id="btnKeep">Nudel behalten</button>
        <button id="btnRemove">Nudel entfernen</button>
        <button class="btnSecondary" id="btnCoinflip">Coinflip entscheidet</button>
        <button class="btnSecondary" id="btnCloseWinner">Schlie√üen</button>
      </div>
      <div class="smallNote" id="miniInfo" style="display:none;"></div>
    </div>
  </div>

  <!-- Streamer Luck -->
  <div class="overlay" id="luckOverlay">
    <div class="box">
      <h2>Streamer Luck</h2>
      <p>W√§hle einen Namen aus der Liste. Der wird 2x eingetragen (doppelte Chance).</p>
      <div class="row">
        <select id="luckSelect" class="field"></select>
      </div>
      <div class="boxActions">
        <button id="luckConfirm">Best√§tigen</button>
        <button class="btnSecondary" id="luckCancel">Abbrechen</button>
      </div>
      <div class="smallNote">Tipp: Du kannst es jederzeit nochmal machen.</div>
    </div>
  </div>

  <!-- Mini Overlay -->
  <div class="overlay" id="miniOverlay">
    <div class="box">
      <h2 id="miniTitle">Mini Game</h2>
      <p id="miniText">---</p>
      <div class="boxActions" id="miniActions"></div>
      <div class="smallNote" id="miniFoot">---</div>
    </div>
  </div>

  <div class="toast" id="toast">---</div>
  <div class="wm-btn" id="wmBtn" title=""></div>

  <div class="wrap">
    <div class="header">
      <div class="title" id="secretTitle">BAFFE WHEEL</div>

      <div class="toggles">
        <select id="bgMode">
          <option value="transparent">Transparent (OBS)</option>
          <option value="solid" selected>Solid Background</option>
        </select>

        <select id="mode">
          <option value="remove" selected>Modus: Nudel entfernen</option>
          <option value="keep">Modus: Nudel behalten</option>
        </select>

        <button class="miniBtn" id="luckBtn">Streamer Luck</button>
      </div>
    </div>

    <div class="wheelBox">
      <div class="pin" id="pin"></div>
      <canvas id="wheel" width="1000" height="1000"></canvas>
      <div class="centerCap" id="centerCap"></div>
    </div>

    <div class="controls">
      <button id="spin">Nudel umr√ºhren</button>
      <button id="removeWinner" disabled>Nudel entfernen</button>
      <button id="shuffle">Shuffle</button>
      <button id="reset">Reset</button>
    </div>

    <textarea id="items" rows="7" placeholder="Jeder Eintrag in eine neue Zeile">Hydrate
5 Liegest√ºtze
Chat entscheidet
Song anmachen
Stretch
1 Runde Ranked</textarea>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const TAU = Math.PI * 2;

    const canvas = $("wheel");
    const ctx = canvas.getContext("2d");

    const btnSpin = $("spin");
    const btnRemoveWinner = $("removeWinner");
    const btnShuffle = $("shuffle");
    const btnReset = $("reset");

    const input = $("items");
    const bgMode = $("bgMode");
    const mode = $("mode");

    const pin = $("pin");
    const centerCap = $("centerCap");

    const secretTitle = $("secretTitle");
    const ahaOverlay = $("ahaOverlay");
    const ahaClose = $("ahaClose");

    const winnerOverlay = $("winnerOverlay");
    const winnerNameEl = $("winnerName");
    const winnerSubtitle = $("winnerSubtitle");
    const btnKeep = $("btnKeep");
    const btnRemove = $("btnRemove");
    const btnCoinflip = $("btnCoinflip");
    const btnCloseWinner = $("btnCloseWinner");
    const miniInfo = $("miniInfo");

    const luckBtn = $("luckBtn");
    const luckOverlay = $("luckOverlay");
    const luckSelect = $("luckSelect");
    const luckConfirm = $("luckConfirm");
    const luckCancel = $("luckCancel");

    const miniOverlay = $("miniOverlay");
    const miniTitle = $("miniTitle");
    const miniText = $("miniText");
    const miniActions = $("miniActions");
    const miniFoot = $("miniFoot");

    const toast = $("toast");
    const wmBtn = $("wmBtn");

    const STORAGE_KEY = "baffeWheel_v4";
    const now = () => Date.now();

    let items = [];
    let angle = 0;
    let spinning = false;
    let lastWinner = null;

    // Easter stuff
    let secretClicks = 0;
    let ahaMode = false;
    let glowMode = false;

    // Ultra spin
    let ultraReadyAt = 0;
    let pinClicks = 0;
    let pinClickTimer = null;

    // Reverse spin (2%)
    const REVERSE_CHANCE = 0.02;

    // Konami code
    const konami = ["ArrowUp","ArrowUp","ArrowDown","ArrowDown","ArrowLeft","ArrowRight","ArrowLeft","ArrowRight","b","a"];
    let konamiPos = 0;

    function showToast(text){
      toast.textContent = text;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2200);
    }

    function applyBgMode(val){
      document.body.classList.remove("transparent","solid");
      document.body.classList.add(val);
    }

    function parseItems(text){
      const raw = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

      const out = [];
      let seenAha = false;
      for (const r of raw){
        if (r.toLowerCase() === "aha") seenAha = true;
        out.push(r);
      }
      if (seenAha && !out.some(x => x === "AHA")) out.push("AHA");
      return out;
    }

    function persist(){
      const payload = {
        itemsText: input.value,
        bg: bgMode.value,
        mode: mode.value,
        ahaMode,
        glowMode
      };
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); }catch(e){}
    }

    function restore(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const p = JSON.parse(raw);
        if(typeof p.itemsText === "string") input.value = p.itemsText;
        if(p.bg === "transparent" || p.bg === "solid") bgMode.value = p.bg;
        if(p.mode === "remove" || p.mode === "keep") mode.value = p.mode;
        ahaMode = !!p.ahaMode;
        glowMode = !!p.glowMode;
      }catch(e){}
    }

    function palette(i){
      const normal = ["#00c3ff","#6a5cff","#ff2bd6","#4d9fff","#8a5cff"];
      const aha = ["#ffd400","#ff7a00","#ff2bd6","#00ffb3","#6a5cff"];
      const g = ["#9cff00","#00c3ff","#ff2bd6","#ffd400","#6a5cff"];
      const arr = glowMode ? g : (ahaMode ? aha : normal);
      return arr[i % arr.length];
    }

    function draw(){
      const w = canvas.width, h = canvas.height;
      const cx = w/2, cy = h/2;
      const r = Math.min(w, h) * 0.48;

      ctx.clearRect(0,0,w,h);

      const n = Math.max(2, items.length || 2);
      const slice = TAU / n;

      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle);

      for(let i=0;i<n;i++){
        const start = i * slice;
        const end = start + slice;

        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,r, start, end);
        ctx.closePath();
        ctx.fillStyle = palette(i);
        ctx.fill();

        ctx.strokeStyle = "rgba(0,0,0,.18)";
        ctx.lineWidth = 6;
        ctx.stroke();

        const label = items[i] || "‚Äî";
        ctx.save();
        ctx.rotate(start + slice/2);
        ctx.textAlign = "right";
        ctx.fillStyle = "rgba(0,0,0,.78)";
        ctx.font = "900 44px system-ui";
        ctx.shadowColor = "rgba(255,255,255,.55)";
        ctx.shadowBlur = 6;
        ctx.fillText(label, r - 24, 14);
        ctx.restore();
      }

      ctx.restore();
    }

    function currentWinner(){
      const n = items.length;
      const slice = TAU / n;
      const pointerAngle = -Math.PI/2;
      const a = ((pointerAngle - angle) % TAU + TAU) % TAU;
      const idx = Math.floor(a / slice) % n;
      return { idx, label: items[idx] ?? "‚Äî" };
    }

    function showWinnerPopup(name){
      winnerNameEl.textContent = name;
      winnerSubtitle.textContent = "Was willst du machen?";
      miniInfo.style.display = "none";
      winnerOverlay.style.display = "grid";
    }
    function hideWinnerPopup(){ winnerOverlay.style.display = "none"; }

    function showAhaPopup(){
      ahaOverlay.style.display = "grid";
      document.body.classList.add("ahaFlash");
      setTimeout(() => document.body.classList.remove("ahaFlash"), 400);
    }
    function hideAhaPopup(){ ahaOverlay.style.display = "none"; }

    function openLuck(){
      const cur = parseItems(input.value);
      const uniq = Array.from(new Set(cur));
      luckSelect.innerHTML = "";
      for(const n of uniq){
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        luckSelect.appendChild(opt);
      }
      if(!uniq.length){ showToast("Erst Namen eintragen üôÇ"); return; }
      luckOverlay.style.display = "grid";
    }
    function closeLuck(){ luckOverlay.style.display = "none"; }

    function addLuckName(name){
      let cur = parseItems(input.value);
      cur.push(name);
      input.value = cur.join("\n");
      items = parseItems(input.value);
      persist();
      draw();
      showToast(name + " hat jetzt 2x Chance");
    }

    function updateRemoveButton(){
      const canRemove = (mode.value === "remove") && items.length > 1;
      btnRemoveWinner.disabled = !canRemove;
    }

    function removeLastWinner(){
      if(!lastWinner) return;
      const label = lastWinner.label;
      const idx = items.findIndex(x => x === label);
      if(idx !== -1){
        items.splice(idx,1);
        input.value = items.join("\n");
        persist();
      }
      lastWinner = null;
      btnRemoveWinner.disabled = true;
      draw();
    }

    function shuffle(){
      items = parseItems(input.value);
      for (let i = items.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [items[i], items[j]] = [items[j], items[i]];
      }
      input.value = items.join("\n");
      lastWinner = null;
      btnRemoveWinner.disabled = true;
      persist();
      draw();
      showToast("Gemischt");
    }

    function reset(){
      angle = 0;
      lastWinner = null;
      btnRemoveWinner.disabled = true;
      draw();
      showToast("Reset");
    }

    function openMini({title, text, actions, foot}){
      miniTitle.textContent = title;
      miniText.textContent = text;
      miniActions.innerHTML = "";
      for(const a of actions){
        const b = document.createElement("button");
        b.textContent = a.label;
        if(a.kind === "secondary") b.classList.add("btnSecondary");
        b.addEventListener("click", a.onClick);
        miniActions.appendChild(b);
      }
      miniFoot.textContent = foot || "";
      miniOverlay.style.display = "grid";
    }
    function closeMini(){ miniOverlay.style.display = "none"; }

    // SOUND (spin + pop + sad)
    let audioCtx = null;
    let spinOsc = null;
    let spinNoise = null;
    let spinGain = null;
    let soundEnabled = true; // kannst du sp√§ter easy auf false setzen

    function ensureAudio(){
      if(audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    function startSpinSound(){
      if(!soundEnabled) return;
      ensureAudio();
      if(audioCtx.state === "suspended") audioCtx.resume();

      spinGain = audioCtx.createGain();
      spinGain.gain.value = 0.0;
      spinGain.connect(audioCtx.destination);

      spinOsc = audioCtx.createOscillator();
      spinOsc.type = "sawtooth";
      spinOsc.frequency.value = 120;
      spinOsc.connect(spinGain);
      spinOsc.start();

      spinNoise = audioCtx.createOscillator();
      spinNoise.type = "triangle";
      spinNoise.frequency.value = 40;
      spinNoise.connect(spinGain);
      spinNoise.start();

      const t = audioCtx.currentTime;
      spinGain.gain.setValueAtTime(0.0, t);
      spinGain.gain.linearRampToValueAtTime(0.06, t + 0.15);
    }

    function updateSpinSound(speed01){
      if(!soundEnabled || !spinGain || !audioCtx) return;
      const t = audioCtx.currentTime;
      const vol = 0.03 + 0.08 * speed01;
      spinGain.gain.setTargetAtTime(vol, t, 0.03);
      if(spinOsc) spinOsc.frequency.setTargetAtTime(110 + 260 * speed01, t, 0.03);
      if(spinNoise) spinNoise.frequency.setTargetAtTime(25 + 85 * speed01, t, 0.03);
    }

    function stopSpinSoundPop(){
      if(!soundEnabled || !audioCtx) return;

      // pop
      const pop = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      pop.type = "sine";
      pop.frequency.value = 480;
      g.gain.value = 0.0001;
      pop.connect(g);
      g.connect(audioCtx.destination);

      const t = audioCtx.currentTime;
      g.gain.setValueAtTime(0.0001, t);
      g.gain.linearRampToValueAtTime(0.12, t + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.12);

      pop.start(t);
      pop.stop(t + 0.13);

      // fade spin out
      if(spinGain) spinGain.gain.setTargetAtTime(0.0, t, 0.02);
      setTimeout(() => {
        try{ if(spinOsc) spinOsc.stop(); }catch(e){}
        try{ if(spinNoise) spinNoise.stop(); }catch(e){}
        spinOsc = null; spinNoise = null; spinGain = null;
      }, 200);
    }

    function playSadSound(){
      if(!soundEnabled) return;
      ensureAudio();
      if(audioCtx.state === "suspended") audioCtx.resume();

      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();

      o.type = "triangle";
      o.frequency.value = 260;

      o.connect(g);
      g.connect(audioCtx.destination);

      const t = audioCtx.currentTime;
      g.gain.setValueAtTime(0.0001, t);
      g.gain.linearRampToValueAtTime(0.14, t + 0.02);

      o.frequency.setValueAtTime(260, t);
      o.frequency.exponentialRampToValueAtTime(150, t + 0.22);
      o.frequency.exponentialRampToValueAtTime(110, t + 0.45);

      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.55);

      o.start(t);
      o.stop(t + 0.56);
    }

    function coinflip(){
      // bisschen show
      const r = Math.random() < 0.5 ? "Kopf" : "Zahl";
      // Kopf = behalten, Zahl = entfernen (kannst du tauschen wenn du willst)
      const remove = (r === "Zahl");
      return { result: r, remove };
    }

    function spin({ultra=false} = {}){
      if(spinning) return;

      items = parseItems(input.value);
      if(items.length < 2){
        showToast("Mindestens 2 Eintr√§ge üôÇ");
        draw();
        return;
      }

      // 2% Reverse Spin
      const reverse = Math.random() < REVERSE_CHANCE;

      spinning = true;
      btnSpin.disabled = true;
      btnRemoveWinner.disabled = true;

      startSpinSound();

      const extraSpins = ultra ? 14 : 8;
      const duration = ultra ? 2400 : 3800;

      const n = items.length;
      const slice = TAU / n;

      const targetIndex = Math.floor(Math.random() * n);
      const inside = (Math.random()*0.6 + 0.2) * slice;

      const pointerAngle = -Math.PI/2;

      // Zielwinkel so, dass targetIndex am Zeiger landet
      const targetAngle = pointerAngle - (targetIndex*slice + inside);

      const startAngle = angle;

      // normal: runter drehen (negativ), reverse: hoch drehen (positiv)
      const endAngle = reverse
        ? (targetAngle + extraSpins * TAU)
        : (targetAngle - extraSpins * TAU);

      const start = performance.now();
      const easeOutCubic = t => 1 - Math.pow(1 - t, 3);

      function frame(nowT){
        const t = Math.min(1, (nowT - start) / duration);
        const e = easeOutCubic(t);
        angle = startAngle + (endAngle - startAngle) * e;

        const speed01 = ultra ? (1 - t) * 1.1 : (1 - t);
        updateSpinSound(Math.max(0, Math.min(1, speed01)));

        draw();

        if(t < 1){
          requestAnimationFrame(frame);
        }else{
          spinning = false;
          btnSpin.disabled = false;

          angle = ((angle % TAU) + TAU) % TAU;

          lastWinner = currentWinner();
          updateRemoveButton();

          stopSpinSoundPop();

          // winner popup
          showWinnerPopup(lastWinner.label);

          // mini hint selten
          if(Math.random() < 0.12){
            miniInfo.style.display = "block";
            miniInfo.textContent = "Geheim: 3x Pin = Ultra Spin. 10x Center = AHA Mode. Konami-Code üòâ";
          }

          if(reverse) showToast("Reverse Spin üòà");

          if(lastWinner.label === "AHA") showAhaPopup();
        }
      }

      requestAnimationFrame(frame);
    }

    // --- EVENTS ---

    // AHA secret (15 clicks on title)
    secretTitle.addEventListener("click", () => {
      secretClicks++;
      if(secretClicks >= 15){
        secretClicks = 0;
        showAhaPopup();
      }
    });

    ahaClose.addEventListener("click", hideAhaPopup);
    ahaOverlay.addEventListener("click", (e) => { if(e.target === ahaOverlay) hideAhaPopup(); });

    // Winner popup buttons
    btnCloseWinner.addEventListener("click", hideWinnerPopup);
    winnerOverlay.addEventListener("click", (e) => { if(e.target === winnerOverlay) hideWinnerPopup(); });

    btnKeep.addEventListener("click", () => {
      hideWinnerPopup();
      showToast("Nudel behalten");
    });

    btnRemove.addEventListener("click", () => {
      playSadSound();
      removeLastWinner();
      hideWinnerPopup();
      showToast("Nudel entfernt");
    });

    btnCoinflip.addEventListener("click", () => {
      if(!lastWinner){ hideWinnerPopup(); return; }
      const f = coinflip();
      openMini({
        title: "Coinflip ü™ô",
        text: "Ergebnis: " + f.result,
        actions: [
          { label: "OK", kind: "secondary", onClick: () => {
              closeMini();
              if(f.remove){
                playSadSound();
                removeLastWinner();
                showToast("Coinflip: entfernt");
              }else{
                showToast("Coinflip: behalten");
              }
              hideWinnerPopup();
            }
          }
        ],
        foot: "Kopf = behalten, Zahl = entfernen"
      });
    });

    // Streamer Luck
    luckBtn.addEventListener("click", () => {
      const cur = parseItems(input.value);
      const uniq = Array.from(new Set(cur));
      luckSelect.innerHTML = "";
      for(const n of uniq){
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        luckSelect.appendChild(opt);
      }
      if(!uniq.length){ showToast("Erst Namen eintragen üôÇ"); return; }
      luckOverlay.style.display = "grid";
    });

    luckCancel.addEventListener("click", () => luckOverlay.style.display = "none");
    luckOverlay.addEventListener("click", (e) => { if(e.target === luckOverlay) luckOverlay.style.display = "none"; });

    luckConfirm.addEventListener("click", () => {
      const name = luckSelect.value;
      if(!name) return;
      addLuckName(name);
      luckOverlay.style.display = "none";
    });

    // Ultra spin via pin triple-click (cooldown 60s)
    pin.addEventListener("click", () => {
      if(pinClickTimer) clearTimeout(pinClickTimer);
      pinClicks++;
      pinClickTimer = setTimeout(() => { pinClicks = 0; }, 600);

      if(pinClicks >= 3){
        pinClicks = 0;
        if(now() < ultraReadyAt){
          const sec = Math.ceil((ultraReadyAt - now())/1000);
          showToast("Ultra Spin cooldown: " + sec + "s");
          return;
        }
        ultraReadyAt = now() + 60000;
        showToast("Ultra Spin!");
        spin({ultra:true});
      }
    });

    // AHA Mode via center 10 clicks
    let capClicks = 0;
    let capTimer = null;
    centerCap.addEventListener("click", () => {
      if(capTimer) clearTimeout(capTimer);
      capClicks++;
      capTimer = setTimeout(() => { capClicks = 0; }, 800);

      if(capClicks >= 10){
        capClicks = 0;
        ahaMode = !ahaMode;
        persist();
        draw();
        showToast(ahaMode ? "AHA Mode ON" : "AHA Mode OFF");
      }
    });

    // watermark click
    wmBtn.addEventListener("click", () => showToast("NicoRU / AimWieNhSocke"));

    // keyboard: Konami toggles glow + shows AHA
    document.addEventListener("keydown", (e) => {
      const tag = (document.activeElement && document.activeElement.tagName) ? document.activeElement.tagName.toLowerCase() : "";
      const typing = (tag === "textarea" || tag === "input" || tag === "select");

      const key = e.key;
      const k = (key.length === 1) ? key.toLowerCase() : key;
      const expected = konami[konamiPos];
      const normalizedExpected = (expected.length === 1) ? expected.toLowerCase() : expected;

      if(k === normalizedExpected){
        konamiPos++;
        if(konamiPos === konami.length){
          konamiPos = 0;
          glowMode = !glowMode;
          persist();
          draw();
          showToast(glowMode ? "Glow Mode ON" : "Glow Mode OFF");
          showAhaPopup();
        }
      }else{
        konamiPos = 0;
      }

      if(typing) return;

      // G toggle glow
      if(e.key.toLowerCase() === "g"){
        glowMode = !glowMode;
        persist();
        draw();
        showToast(glowMode ? "Glow Mode ON" : "Glow Mode OFF");
      }

      // Space spin
      if(e.code === "Space"){
        e.preventDefault();
        spin();
      }

      // Esc close popups
      if(e.key === "Escape"){
        hideWinnerPopup();
        hideAhaPopup();
        closeLuck();
        closeMini();
      }
    });

    // buttons
    btnSpin.addEventListener("click", () => spin());

    btnRemoveWinner.addEventListener("click", () => {
      playSadSound();
      removeLastWinner();
      showToast("Nudel entfernt");
    });

    btnShuffle.addEventListener("click", shuffle);
    btnReset.addEventListener("click", reset);

    // input live
    input.addEventListener("input", () => {
      items = parseItems(input.value);
      lastWinner = null;
      btnRemoveWinner.disabled = true;
      persist();
      draw();
    });

    bgMode.addEventListener("change", () => { applyBgMode(bgMode.value); persist(); });
    mode.addEventListener("change", () => { updateRemoveButton(); persist(); });

    miniOverlay.addEventListener("click", (e) => { if(e.target === miniOverlay) closeMini(); });

    // init
    restore();
    applyBgMode(bgMode.value);
    items = parseItems(input.value);
    updateRemoveButton();
    draw();
    persist();
  </script>
</body>
</html>
